# Copyright 2025 Vinicius Fortuna
# SPDX-License-Identifier: 	Apache-2.0

# We have identical, but separate definitions for input and output.
# This is a hack to use full-duplex. It works as long as they have the same
# sample rate.
# Inspired by https://github.com/formatBCE/Koala-Satellite/blob/main/config/common/koala-base.yaml
.shared_i2s: &shared_i2s
  i2s_lrclk_pin:
    number: GPIO45  # I2S_LRCK
    allow_other_uses: true
  i2s_bclk_pin:
    number: GPIO17  # I2S_SCLK
    allow_other_uses: true
  i2s_mclk_pin:
    number: GPIO02  # I2S_MCLK
    allow_other_uses: true

i2s_audio:
  - id: i2s_input
    <<: *shared_i2s
  - id: i2s_output
    <<: *shared_i2s

audio_adc:
  - id: es7210_adc
    platform: es7210
    i2c_id: i2c_bus
    bits_per_sample: 16bit
    sample_rate: 16000

audio_dac:
  - id: es8311_dac
    platform: es8311
    i2c_id: i2c_bus
    bits_per_sample: 16bit
    sample_rate: 16000

microphone:
  - id: box_microphone
    platform: i2s_audio
    adc_type: external
    i2s_audio_id: i2s_input
    i2s_din_pin: GPIO16  # I2S_ADC_SDOUT
    i2s_mode: secondary
    bits_per_sample: 16bit
    sample_rate: 16000

speaker:
  - id: box_speaker
    platform: i2s_audio
    i2s_audio_id: i2s_output
    i2s_dout_pin: GPIO15  # I2S_CODEC_DSDIN
    i2s_mode: secondary
    dac_type: external
    audio_dac: es8311_dac
    sample_rate: 16000
    bits_per_sample: 16bit
    buffer_duration: 100ms

switch:
  - platform: gpio
    name: Enable Speaker
    id: enable_speaker
    pin: GPIO46
    # I've wasted hours of my life trying to figure out why the speaker
    # was not working, only to find out that the GPIO46 pin needs to be
    # set to HIGH to enable the speaker. Let's make it ON by default.
    restore_mode: RESTORE_DEFAULT_ON
    entity_category: config
    disabled_by_default: true
